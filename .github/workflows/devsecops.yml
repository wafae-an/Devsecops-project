# DevSecOps Pipeline for OWASP NodeGoat
# ================================================================================
# This workflow implements a complete DevSecOps pipeline with:
# - Continuous Integration (CI): Build, test, and lint
# - Static Application Security Testing (SAST): CodeQL analysis
# - Software Composition Analysis (SCA): Dependency vulnerability scanning
# - Dynamic Application Security Testing (DAST): OWASP ZAP baseline scan
# 
# All security reports are uploaded as artifacts for review.
# ================================================================================

name: DevSecOps Pipeline

on:
  push:
    branches:
      - main
      - master
      - develop
  pull_request:
    branches:
      - main
      - master
      - develop
  workflow_dispatch:  # Allow manual triggers

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ================================================================================
  # JOB 1: Continuous Integration (CI)
  # ================================================================================
  continuous-integration:
    name: ğŸ§± Continuous Integration
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./app
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: app/package-lock.json

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ”¨ Build application
        run: |
          if grep -q '"build"' package.json; then
            npm run build
          else
            echo "No build script found, skipping..."
          fi
        continue-on-error: true

      - name: ğŸ§ª Run tests
        run: |
          if grep -q '"test"' package.json; then
            npm test
          else
            echo "No test script found, skipping..."
          fi
        continue-on-error: true

      - name: ğŸ” Run linter
        run: |
          if grep -q '"lint"' package.json; then
            npm run lint
          else
            echo "No lint script found, skipping..."
          fi
        continue-on-error: true

      - name: ğŸ“Š Generate CI report
        if: always()
        run: |
          echo "=====================================" > ci-report.txt
          echo "Continuous Integration Report" >> ci-report.txt
          echo "=====================================" >> ci-report.txt
          echo "" >> ci-report.txt
          echo "Timestamp: $(date)" >> ci-report.txt
          echo "Branch: ${{ github.ref_name }}" >> ci-report.txt
          echo "Commit: ${{ github.sha }}" >> ci-report.txt
          echo "Workflow: ${{ github.workflow }}" >> ci-report.txt
          echo "" >> ci-report.txt
          echo "=====================================" >> ci-report.txt
          echo "Dependencies installed successfully" >> ci-report.txt
          echo "Build, test, and lint stages completed" >> ci-report.txt
          echo "=====================================" >> ci-report.txt

      - name: ğŸ“¤ Upload CI report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-report
          path: app/ci-report.txt
          retention-days: 3

  # ================================================================================
  # JOB 2: Static Application Security Testing (SAST) - CodeQL + HTML Report
  # ================================================================================
  sast-codeql:
    name: ğŸ” SAST - CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript
          queries: security-extended,security-and-quality

      - name: ğŸ”¬ Perform CodeQL Analysis
        id: analyze
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:javascript"
          output: sast-codeql-report
          upload: false
        continue-on-error: true

      - name: ğŸ“„ Convert SARIF to HTML + Summary
        if: always()
        run: |
          echo "ğŸ”§ Installing Python and sarif-tools..."
          sudo apt-get update -y
          sudo apt-get install -y python3-pip jq
          pip install sarif-tools

          echo "ğŸ“Š Generating HTML and summary reports..."
          mkdir -p sast-codeql-report

          SARIF_FILE=$(find sast-codeql-report -name "*.sarif" | head -n 1)
          if [ -f "$SARIF_FILE" ]; then
            echo "âœ… SARIF file found: $SARIF_FILE"
            sarif html "$SARIF_FILE" -o sast-codeql-report/codeql-report.html
            sarif summary "$SARIF_FILE" > sast-codeql-report/codeql-summary.txt

            ERROR_COUNT=$(jq '[.runs[].results[] | select(.level=="error")] | length' "$SARIF_FILE")
            WARNING_COUNT=$(jq '[.runs[].results[] | select(.level=="warning")] | length' "$SARIF_FILE")
            NOTE_COUNT=$(jq '[.runs[].results[] | select(.level=="note")] | length' "$SARIF_FILE")
            TOTAL_COUNT=$(jq '[.runs[].results[]] | length' "$SARIF_FILE")

            {
              echo "====================================="
              echo "CodeQL SAST Analysis Report"
              echo "====================================="
              echo "Timestamp: $(date)"
              echo "Language: JavaScript"
              echo "Queries: security-extended, security-and-quality"
              echo ""
              echo "ğŸ”´ Critical/Error: $ERROR_COUNT"
              echo "ğŸŸ¡ Warning: $WARNING_COUNT"
              echo "ğŸ”µ Note/Info: $NOTE_COUNT"
              echo "ğŸ“‹ Total Issues: $TOTAL_COUNT"
              echo ""
              echo "Top 10 vulnerabilities:"
              jq -r '.runs[].results[] | "â€¢ [\(.level)] \(.ruleId): \(.message.text)"' "$SARIF_FILE" | head -n 10
              echo ""
              echo "Full HTML report available: codeql-report.html"
              echo "====================================="
            } > sast-codeql-report/summary.txt
          else
            echo "âŒ No SARIF file found. Creating placeholder."
            echo "<html><body><h2>No vulnerabilities detected or analysis failed</h2></body></html>" > sast-codeql-report/codeql-report.html
            echo "No vulnerabilities detected." > sast-codeql-report/summary.txt
          fi
        continue-on-error: true

      - name: ğŸ“¤ Upload SAST Report Folder
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sast-codeql-report
          path: sast-codeql-report/
          retention-days: 30

  # ================================================================================
  # JOB 3: Software Composition Analysis (SCA)
  # ================================================================================
  sca-dependencies:
    name: ğŸ§° SCA - Dependency Scanning
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./app
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: app/package-lock.json

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ›¡ï¸ Run Snyk scan
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          if [ -n "$SNYK_TOKEN" ]; then
            echo "Running Snyk security scan..."
            npx snyk test --json > snyk-report.json || true
            npx snyk test > snyk-report.txt || true
          else
            echo "SNYK_TOKEN not found, skipping Snyk scan"
          fi
        continue-on-error: true

      - name: ğŸ” Run npm audit (fallback)
        run: |
          echo "Running npm audit..."
          npm audit --json > audit-report.json || true
          npm audit > audit-report.txt || true
          echo "npm audit completed"
        continue-on-error: true

      - name: ğŸ“Š Generate SCA summary report
        if: always()
        run: |
          echo "=====================================" > sca-summary.txt
          echo "Software Composition Analysis Report" >> sca-summary.txt
          echo "=====================================" >> sca-summary.txt
          echo "" >> sca-summary.txt
          echo "Timestamp: $(date)" >> sca-summary.txt
          echo "Project: OWASP NodeGoat" >> sca-summary.txt
          echo "" >> sca-summary.txt

          if [ -f "snyk-report.json" ]; then
            echo "âœ… Snyk scan completed" >> sca-summary.txt
            echo "   Report: snyk-report.json" >> sca-summary.txt
          else
            echo "âš ï¸  Snyk scan skipped (no SNYK_TOKEN)" >> sca-summary.txt
          fi

          if [ -f "audit-report.json" ]; then
            echo "âœ… npm audit completed" >> sca-summary.txt
            echo "   Report: audit-report.json" >> sca-summary.txt
            echo "" >> sca-summary.txt
            echo "--- npm audit summary ---" >> sca-summary.txt
            cat audit-report.txt >> sca-summary.txt
          fi
          echo "" >> sca-summary.txt
          echo "=====================================" >> sca-summary.txt

      - name: ğŸ“¤ Upload SCA reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sca-dependency-reports
          path: |
            app/snyk-report.json
            app/snyk-report.txt
            app/audit-report.json
            app/audit-report.txt
            app/sca-summary.txt
          retention-days: 30
  # ============================================================================
  # JOB 4: Dynamic Application Security Testing (DAST)
  # ============================================================================
  dast-zap-scan:
    name: ğŸŒ DAST - OWASP ZAP Scan
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
      security-events: write
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
  
      - name: ğŸ³ Start NodeGoat application
        working-directory: ./app
        run: |
          echo "ğŸ”¨ Building and starting NodeGoat with Docker Compose..."
          docker compose up -d --build
          echo "â³ Waiting for MongoDB to be ready..."
          sleep 10
          echo "â³ Waiting for NodeGoat application to be ready..."
          timeout=120
          elapsed=0
          until curl -sf http://localhost:4000 >/dev/null 2>&1; do
            if [ $elapsed -ge $timeout ]; then
              echo "âŒ Application failed to start within $timeout seconds"
              docker compose logs
              docker compose ps
              docker ps -a
              exit 1
            fi
            echo "â±ï¸ Waiting for NodeGoat... ($elapsed/$timeout seconds)"
            sleep 5
            elapsed=$((elapsed + 5))
          done
          echo "âœ… NodeGoat is running on http://localhost:4000"
  
      - name: ğŸ•·ï¸ Run OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.10.0
        with:
          target: 'http://localhost:4000'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a -j -l PASS'
        continue-on-error: true
  
      - name: ğŸ“Š Generate DAST Report Summary
        if: always()
        run: |
          echo "=====================================" > dast-summary.txt
          echo "OWASP ZAP DAST Scan Report" >> dast-summary.txt
          echo "=====================================" >> dast-summary.txt
          echo "Timestamp: $(date)" >> dast-summary.txt
          echo "Target: http://localhost:4000" >> dast-summary.txt
          echo "Scanner: OWASP ZAP Baseline" >> dast-summary.txt
  
          if [ -f "report_json.json" ]; then
            HIGH=$(jq '[.site[].alerts[] | select(.riskcode=="3")] | length' report_json.json 2>/dev/null || echo "0")
            MEDIUM=$(jq '[.site[].alerts[] | select(.riskcode=="2")] | length' report_json.json 2>/dev/null || echo "0")
            LOW=$(jq '[.site[].alerts[] | select(.riskcode=="1")] | length' report_json.json 2>/dev/null || echo "0")
            INFO=$(jq '[.site[].alerts[] | select(.riskcode=="0")] | length' report_json.json 2>/dev/null || echo "0")
            TOTAL=$((HIGH + MEDIUM + LOW + INFO))
  
            {
              echo "â”œâ”€â”€ ğŸ”´ High Risk: $HIGH"
              echo "â”œâ”€â”€ ğŸŸ  Medium Risk: $MEDIUM"
              echo "â”œâ”€â”€ ğŸŸ¡ Low Risk: $LOW"
              echo "â”œâ”€â”€ ğŸ”µ Informational: $INFO"
              echo "â””â”€â”€ ğŸ“‹ Total Alerts: $TOTAL"
            } >> dast-summary.txt
  
            if [ "$TOTAL" -gt 0 ]; then
              HIGH_PCT=$(awk "BEGIN {printf \"%.1f\", ($HIGH/$TOTAL)*100}")
              MEDIUM_PCT=$(awk "BEGIN {printf \"%.1f\", ($MEDIUM/$TOTAL)*100}")
              LOW_PCT=$(awk "BEGIN {printf \"%.1f\", ($LOW/$TOTAL)*100}")
              INFO_PCT=$(awk "BEGIN {printf \"%.1f\", ($INFO/$TOTAL)*100}")
              {
                echo "ğŸ“ˆ Risk Distribution:"
                echo "â”œâ”€â”€ High: $HIGH_PCT%"
                echo "â”œâ”€â”€ Medium: $MEDIUM_PCT%"
                echo "â”œâ”€â”€ Low: $LOW_PCT%"
                echo "â””â”€â”€ Info: $INFO_PCT%"
                echo "ğŸ” Top Vulnerabilities Found:"
              } >> dast-summary.txt
  
              jq -r '.site[].alerts[] | "  â€¢ [\(.risk | ascii_upcase)] \(.name) - Confidence: \(.confidence)"' report_json.json 2>/dev/null | sort -u | head -n 10 >> dast-summary.txt
            else
              echo "âœ… No vulnerabilities detected!" >> dast-summary.txt
            fi
          else
            echo "âš ï¸ No JSON report found â€” scan may have failed or completed without findings." >> dast-summary.txt
          fi
  
      - name: ğŸ“¤ Upload ZAP Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dast-zap-report
          path: |
            report_html.html
            report_md.md
            report_json.json
            dast-summary.txt
          retention-days: 30
  
      - name: ğŸ§¹ Cleanup Docker Containers
        if: always()
        working-directory: ./app
        run: |
          docker compose down -v

  # ================================================================================
  # JOB 5: Final Report Aggregation
  # ================================================================================
  generate-final-report:
    name: ğŸ§¾ Generate Final DevSecOps Report
    runs-on: ubuntu-latest
    needs: [continuous-integration, sast-codeql, sca-dependencies, dast-zap-scan]
    if: always()

    steps:
      - name: ğŸ“¥ Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-reports

      - name: ğŸ“Š Generate consolidated report
        run: |
          echo "==========================================================" > final-devsecops-report.txt
          echo "         DevSecOps Pipeline - Final Report" >> final-devsecops-report.txt
          echo "         OWASP NodeGoat Security Assessment" >> final-devsecops-report.txt
          echo "==========================================================" >> final-devsecops-report.txt
          echo "" >> final-devsecops-report.txt
          echo "Pipeline Run: ${{ github.run_number }}" >> final-devsecops-report.txt
          echo "Timestamp: $(date)" >> final-devsecops-report.txt
          echo "Branch: ${{ github.ref_name }}" >> final-devsecops-report.txt
          echo "Commit: ${{ github.sha }}" >> final-devsecops-report.txt
          echo "Triggered by: ${{ github.actor }}" >> final-devsecops-report.txt
          echo "" >> final-devsecops-report.txt

          echo "==========================================================" >> final-devsecops-report.txt
          echo "Pipeline Stages Summary" >> final-devsecops-report.txt
          echo "==========================================================" >> final-devsecops-report.txt
          echo "" >> final-devsecops-report.txt

          # Check job statuses
          echo "âœ… Stage 1: Continuous Integration (CI)" >> final-devsecops-report.txt
          echo "   Status: ${{ needs.continuous-integration.result }}" >> final-devsecops-report.txt
          echo "" >> final-devsecops-report.txt

          echo "âœ… Stage 2: SAST - CodeQL Analysis" >> final-devsecops-report.txt
          echo "   Status: ${{ needs.sast-codeql.result }}" >> final-devsecops-report.txt
          echo "" >> final-devsecops-report.txt

          echo "âœ… Stage 3: SCA - Dependency Scanning" >> final-devsecops-report.txt
          echo "   Status: ${{ needs.sca-dependencies.result }}" >> final-devsecops-report.txt
          echo "" >> final-devsecops-report.txt

          echo "âœ… Stage 4: DAST - OWASP ZAP Scan" >> final-devsecops-report.txt
          echo "   Status: ${{ needs.dast-zap-scan.result }}" >> final-devsecops-report.txt
          echo "" >> final-devsecops-report.txt

          echo "==========================================================" >> final-devsecops-report.txt
          echo "Available Reports" >> final-devsecops-report.txt
          echo "==========================================================" >> final-devsecops-report.txt
          echo "" >> final-devsecops-report.txt

          find all-reports -type f | while read file; do
            echo "ğŸ“„ $file" >> final-devsecops-report.txt
          done

          echo "" >> final-devsecops-report.txt
          echo "==========================================================" >> final-devsecops-report.txt
          echo "Next Steps" >> final-devsecops-report.txt
          echo "==========================================================" >> final-devsecops-report.txt
          echo "" >> final-devsecops-report.txt
          echo "1. Review all security findings in the artifacts" >> final-devsecops-report.txt
          echo "2. Check the Security tab for CodeQL alerts" >> final-devsecops-report.txt
          echo "3. Prioritize and remediate high/critical vulnerabilities" >> final-devsecops-report.txt
          echo "4. Update dependencies with security patches" >> final-devsecops-report.txt
          echo "5. Re-run the pipeline after fixes" >> final-devsecops-report.txt
          echo "" >> final-devsecops-report.txt
          echo "==========================================================" >> final-devsecops-report.txt

          cat final-devsecops-report.txt

      - name: ğŸ“¤ Upload final consolidated report
        uses: actions/upload-artifact@v4
        with:
          name: final-devsecops-report
          path: |
            final-devsecops-report.txt
            all-reports/
          retention-days: 90

   # ================================================================================
  # JOB 6: Parse and Normalize Security Reports
  # ================================================================================
  parse-security-reports:
    name: ğŸ§  Parse and Normalize Security Reports
    runs-on: ubuntu-latest
    needs: [sast-codeql, sca-dependencies, dast-zap-scan]
  
    steps:
      # --------------------------------------------------------------------------
      # Ã‰tape 1 : Cloner le dÃ©pÃ´t
      # --------------------------------------------------------------------------
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
  
      # --------------------------------------------------------------------------
      # Ã‰tape 2 : TÃ©lÃ©charger les artefacts SAST
      # --------------------------------------------------------------------------
      - name: ğŸ“¥ Download SAST artifacts
        uses: actions/download-artifact@v4
        with:
          name: sast-codeql-report
          path: ./reports/sast
  
      # --------------------------------------------------------------------------
      # Ã‰tape 3 : TÃ©lÃ©charger les artefacts SCA
      # --------------------------------------------------------------------------
      - name: ğŸ“¥ Download SCA artifacts
        uses: actions/download-artifact@v4
        with:
          name: sca-dependency-reports
          path: ./reports/sca
  
      # --------------------------------------------------------------------------
      # Ã‰tape 4 : TÃ©lÃ©charger les artefacts DAST
      # --------------------------------------------------------------------------
      - name: ğŸ“¥ Download DAST artifacts
        uses: actions/download-artifact@v4
        with:
          name: dast-zap-report
          path: ./reports/dast
  
      # --------------------------------------------------------------------------
      # Ã‰tape 5 : VÃ©rifier le contenu tÃ©lÃ©chargÃ©
      # --------------------------------------------------------------------------
      - name: ğŸ“‚ List downloaded files
        run: |
          echo "ğŸ“ Files downloaded:"
          ls -R ./reports || echo "âš ï¸ Aucun fichier trouvÃ© !"
  
      # --------------------------------------------------------------------------
      # Ã‰tape 6 : Installer Node.js pour exÃ©cuter le parser
      # --------------------------------------------------------------------------
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
  
      # --------------------------------------------------------------------------
      # Ã‰tape 7 : CrÃ©er le dossier de sortie
      # --------------------------------------------------------------------------
      - name: ğŸ“ Create output directory
        run: mkdir -p ./parsed-reports
  
      # --------------------------------------------------------------------------
      # Ã‰tape 8 : ExÃ©cuter le parser
      # --------------------------------------------------------------------------
      - name: ğŸ§  Run Parser
        run: |
          echo "ğŸš€ Running AI Parser..."
          node ./app/ai-parser.js
        env:
          REPORTS_DIR: ./reports
          OUTPUT_DIR: ./parsed-reports
          NODE_ENV: production
  
      # --------------------------------------------------------------------------
      # Ã‰tape 9 : VÃ©rifier la sortie gÃ©nÃ©rÃ©e
      # --------------------------------------------------------------------------
      - name: ğŸ“œ List parsed JSON files
        run: |
          echo "âœ… Parsed JSON files generated:"
          ls -R ./parsed-reports || echo "âš ï¸ Aucun fichier gÃ©nÃ©rÃ© par le parser."
  
            # --------------------------------------------------------------------------
      # Ã‰tape 10 : Sauvegarder les fichiers JSON produits
      # --------------------------------------------------------------------------
      - name: ğŸ“¤ Upload parsed JSON artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: parsed-security-reports
          path: ./parsed-reports/
          retention-days: 30
      
           # --------------------------------------------------------------------------
      # Ã‰tape 11 : ğŸ¦™ Installation d'Ollama et LLaMA
      # --------------------------------------------------------------------------
      - name: ğŸ¦™ Install and Setup Ollama
        run: |
          echo "ğŸ“¦ Installation d'Ollama..."
          curl -fsSL https://ollama.com/install.sh | sh
          
          echo "ğŸš€ DÃ©marrage du service Ollama en arriÃ¨re-plan..."
          nohup ollama serve > /tmp/ollama.log 2>&1 &
          
          echo "â³ Attente du dÃ©marrage du service (15 secondes)..."
          sleep 15
          
          echo "âœ… VÃ©rification du service Ollama..."
          curl -s http://localhost:11434/api/tags || echo "âš ï¸ Ollama ne rÃ©pond pas encore"
          
          echo "ğŸ“¥ TÃ©lÃ©chargement du modÃ¨le LLaMA 3.2..."
          ollama pull llama3.2
          
          echo "âœ… Ollama est prÃªt ! ModÃ¨les disponibles :"
          ollama list
      
      # --------------------------------------------------------------------------
      # Ã‰tape 12 : ğŸ“¥ TÃ©lÃ©charger les rapports parsÃ©s
      # --------------------------------------------------------------------------
      - name: ğŸ“¥ Download parsed security reports
        uses: actions/download-artifact@v4
        with:
          name: parsed-security-reports
          path: ./parsed-security-reports
      
      - name: ğŸ” Verify downloaded files
        run: |
          echo "ğŸ“‚ Contenu de ./parsed-security-reports :"
          ls -la ./parsed-security-reports || echo "âš ï¸ Dossier vide ou introuvable"
          
          if [ -d "./parsed-security-reports/prompts" ]; then
            echo "ğŸ“ Prompts trouvÃ©s :"
            ls -la ./parsed-security-reports/prompts
          else
            echo "âš ï¸ Aucun dossier 'prompts' trouvÃ©"
          fi
      
      # --------------------------------------------------------------------------
      # Ã‰tape 13 : ğŸ¤– ExÃ©cuter AI Recommender avec LLaMA
      # --------------------------------------------------------------------------
      - name: ğŸ¤– Run AI Recommender (LLaMA)
        run: |
          echo "ğŸš€ Starting AI Recommender with LLaMA..."
          mkdir -p ai-reports
          
          # VÃ©rifier qu'Ollama fonctionne
          if ! curl -s http://localhost:11434/api/tags > /dev/null; then
            echo "âŒ Ollama n'est pas accessible, redÃ©marrage..."
            nohup ollama serve > /tmp/ollama.log 2>&1 &
            sleep 10
          fi
          
          # ExÃ©cuter le script AI Recommender
          node app/ai_recommender.js ./parsed-security-reports ./ai-reports
          
          echo "âœ… AI-generated reports are ready!"
          echo "ğŸ“Š Contenu de ./ai-reports :"
          ls -lah ./ai-reports
      
      # --------------------------------------------------------------------------
      # Ã‰tape 14 : ğŸ“¤ Upload des rapports IA gÃ©nÃ©rÃ©s
      # --------------------------------------------------------------------------
      - name: ğŸ“¤ Upload AI-generated reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ai-generated-reports
          path: ./ai-reports/
          if-no-files-found: warn
          retention-days: 30
