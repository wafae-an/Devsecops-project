# ================================================================================
# DevSecOps Pipeline for OWASP NodeGoat
# ================================================================================
# This workflow implements a complete DevSecOps pipeline with:
# - Continuous Integration (CI): Build, test, and lint
# - Static Application Security Testing (SAST): CodeQL analysis
# - Software Composition Analysis (SCA): Dependency vulnerability scanning
# - Dynamic Application Security Testing (DAST): OWASP ZAP baseline scan
# 
# All security reports are uploaded as artifacts for review.
# ================================================================================

name: DevSecOps Pipeline

on:
  push:
    branches:
      - main
      - master
      - develop
  pull_request:
    branches:
      - main
      - master
      - develop
  workflow_dispatch:  # Allow manual triggers

# Cancel in-progress runs of the same workflow
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ================================================================================
  # JOB 1: Continuous Integration (CI)
  # ================================================================================
  continuous-integration:
    name: ðŸ§± Continuous Integration
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./app
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: app/package-lock.json
      
      - name: ðŸ“¦ Install dependencies
        run: npm ci
      
      - name: ðŸ”¨ Build application
        run: |
          if grep -q '"build"' package.json; then
            npm run build
          else
            echo "No build script found, skipping..."
          fi
        continue-on-error: true
      
      - name: ðŸ§ª Run tests
        run: |
          if grep -q '"test"' package.json; then
            npm test
          else
            echo "No test script found, skipping..."
          fi
        continue-on-error: true
      
      - name: ðŸ” Run linter
        run: |
          if grep -q '"lint"' package.json; then
            npm run lint
          else
            echo "No lint script found, skipping..."
          fi
        continue-on-error: true
      
      - name: ðŸ“Š Generate CI report
        if: always()
        run: |
          echo "=====================================" > ci-report.txt
          echo "Continuous Integration Report" >> ci-report.txt
          echo "=====================================" >> ci-report.txt
          echo "" >> ci-report.txt
          echo "Timestamp: $(date)" >> ci-report.txt
          echo "Branch: ${{ github.ref_name }}" >> ci-report.txt
          echo "Commit: ${{ github.sha }}" >> ci-report.txt
          echo "Workflow: ${{ github.workflow }}" >> ci-report.txt
          echo "" >> ci-report.txt
          echo "=====================================" >> ci-report.txt
          echo "Dependencies installed successfully" >> ci-report.txt
          echo "Build, test, and lint stages completed" >> ci-report.txt
          echo "=====================================" >> ci-report.txt
      
      - name: ðŸ“¤ Upload CI report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-report
          path: app/ci-report.txt
          retention-days: 30

  # ================================================================================
  # JOB 2: Static Application Security Testing (SAST)
  # ================================================================================
   # ================================================================================
  # JOB 2: Static Application Security Testing (SAST)
  # ================================================================================
  sast-codeql:
    name: ðŸ” SAST - CodeQL Analysis
    runs-on: ubuntu-latest
    
    permissions:
      security-events: write
      actions: read
      contents: read
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript
          queries: security-extended,security-and-quality
          source-root: app/app
      
      - name: ðŸ—ï¸ Autobuild
        uses: github/codeql-action/autobuild@v3
      
      - name: ðŸ”¬ Perform CodeQL Analysis
        id: analyze
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:javascript"
          output: codeql-results
        continue-on-error: true

      # ðŸ§  Convertir le rapport SARIF gÃ©nÃ©rÃ© par CodeQL en HTML lisible
      - name: ðŸ“„ Generate HTML report from SARIF
        if: always()
        run: |
          echo "Generating HTML report from SARIF..."
          mkdir -p sast-html
          SARIF_FILE="codeql-results/javascript.sarif"

          # TÃ©lÃ©charger et installer lâ€™outil Microsoft SARIF Multitool
          npm install -g @microsoft/sarif-multitool

          if [ -f "$SARIF_FILE" ]; then
            echo "SARIF file found: $SARIF_FILE"
            npx @microsoft/sarif-multitool transform \
              --tool="CodeQL" \
              --output sast-html/codeql-report.html \
              --format html \
              "$SARIF_FILE"
            echo "âœ… HTML report generated successfully: sast-html/codeql-report.html"
          else
            echo "âŒ No SARIF file found, skipping HTML conversion."
          fi
        continue-on-error: true

      - name: ðŸ“Š Generate SAST report summary
        if: always()
        run: |
          mkdir -p sast-reports
          echo "=====================================" > sast-reports/codeql-summary.txt
          echo "CodeQL SAST Analysis Report" >> sast-reports/codeql-summary.txt
          echo "=====================================" >> sast-reports/codeql-summary.txt
          echo "" >> sast-reports/codeql-summary.txt
          echo "Timestamp: $(date)" >> sast-reports/codeql-summary.txt
          echo "Language: JavaScript/TypeScript" >> sast-reports/codeql-summary.txt
          echo "Source Directory: app/app/" >> sast-reports/codeql-summary.txt
          echo "Queries: security-extended, security-and-quality" >> sast-reports/codeql-summary.txt
          echo "" >> sast-reports/codeql-summary.txt
          echo "CodeQL analysis completed." >> sast-reports/codeql-summary.txt
          echo "Check the Security tab for detailed results." >> sast-reports/codeql-summary.txt
          echo "=====================================" >> sast-reports/codeql-summary.txt

      # ðŸ“¤ Upload des rapports CodeQL (texte + HTML)
      - name: ðŸ“¤ Upload SAST reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sast-codeql-report
          path: |
            sast-reports/
            sast-html/codeql-report.html
          retention-days: 30


  # ================================================================================
  # JOB 3: Software Composition Analysis (SCA)
  # ================================================================================
  sca-dependencies:
    name: ðŸ§° SCA - Dependency Scanning
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./app
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: app/package-lock.json
      
      - name: ðŸ“¦ Install dependencies
        run: npm ci
      
      - name: ðŸ›¡ï¸ Run Snyk scan
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          if [ -n "$SNYK_TOKEN" ]; then
            echo "Running Snyk security scan..."
            npx snyk test --json > snyk-report.json || true
            npx snyk test > snyk-report.txt || true
            echo "Snyk scan completed"
          else
            echo "SNYK_TOKEN not found, skipping Snyk scan"
            echo "To enable Snyk: Add SNYK_TOKEN to repository secrets"
          fi
        continue-on-error: true
      
      - name: ðŸ” Run npm audit (fallback)
        run: |
          echo "Running npm audit..."
          npm audit --json > audit-report.json || true
          npm audit > audit-report.txt || true
          echo "npm audit completed"
        continue-on-error: true
      
      - name: ðŸ“Š Generate SCA summary report
        if: always()
        run: |
          echo "=====================================" > sca-summary.txt
          echo "Software Composition Analysis Report" >> sca-summary.txt
          echo "=====================================" >> sca-summary.txt
          echo "" >> sca-summary.txt
          echo "Timestamp: $(date)" >> sca-summary.txt
          echo "Project: OWASP NodeGoat" >> sca-summary.txt
          echo "" >> sca-summary.txt
          
          if [ -f "snyk-report.json" ]; then
            echo "âœ… Snyk scan completed" >> sca-summary.txt
            echo "   Report: snyk-report.json" >> sca-summary.txt
          else
            echo "âš ï¸  Snyk scan skipped (no SNYK_TOKEN)" >> sca-summary.txt
          fi
          
          if [ -f "audit-report.json" ]; then
            echo "âœ… npm audit completed" >> sca-summary.txt
            echo "   Report: audit-report.json" >> sca-summary.txt
            echo "" >> sca-summary.txt
            echo "--- npm audit summary ---" >> sca-summary.txt
            cat audit-report.txt >> sca-summary.txt
          fi
          
          echo "" >> sca-summary.txt
          echo "=====================================" >> sca-summary.txt
      
      - name: ðŸ“¤ Upload SCA reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sca-dependency-reports
          path: |
            app/snyk-report.json
            app/snyk-report.txt
            app/audit-report.json
            app/audit-report.txt
            app/sca-summary.txt
          retention-days: 30

  # ================================================================================
  # JOB 4: Dynamic Application Security Testing (DAST)
  # ================================================================================
  dast-zap-scan:
    name: ðŸŒ DAST - OWASP ZAP Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ðŸ³ Start NodeGoat application
        working-directory: ./app
        run: |
          echo "Starting NodeGoat with Docker Compose..."
          docker-compose up -d
          
          echo "Waiting for application to be ready..."
          timeout=60
          elapsed=0
          until curl -f http://localhost:4000 >/dev/null 2>&1 || [ $elapsed -eq $timeout ]; do
            echo "Waiting for NodeGoat to start... ($elapsed/$timeout seconds)"
            sleep 5
            elapsed=$((elapsed + 5))
          done
          
          if [ $elapsed -eq $timeout ]; then
            echo "âŒ Application failed to start within $timeout seconds"
            docker-compose logs
            exit 1
          fi
          
          echo "âœ… NodeGoat is running on http://localhost:4000"
          docker-compose ps
      
      - name: ðŸ•·ï¸ Run OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.10.0
        with:
          target: 'http://localhost:4000'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a -j -l PASS'
        continue-on-error: true
      
      - name: ðŸ“Š Generate DAST report summary
        if: always()
        run: |
          echo "=====================================" > dast-summary.txt
          echo "OWASP ZAP DAST Scan Report" >> dast-summary.txt
          echo "=====================================" >> dast-summary.txt
          echo "" >> dast-summary.txt
          echo "Timestamp: $(date)" >> dast-summary.txt
          echo "Target: http://localhost:4000" >> dast-summary.txt
          echo "Scanner: OWASP ZAP Baseline" >> dast-summary.txt
          echo "" >> dast-summary.txt
          echo "ZAP baseline scan completed." >> dast-summary.txt
          echo "Review the detailed HTML report for findings." >> dast-summary.txt
          echo "" >> dast-summary.txt
          echo "=====================================" >> dast-summary.txt
      
      - name: ðŸ“¤ Upload ZAP reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dast-zap-report
          path: |
            report_html.html
            report_md.md
            report_json.json
            dast-summary.txt
          retention-days: 30
      
      - name: ðŸ§¹ Cleanup Docker containers
        if: always()
        working-directory: ./app
        run: |
          echo "Cleaning up Docker containers..."
          docker-compose down -v
          docker-compose ps
          echo "âœ… Cleanup completed"

  # ================================================================================
  # JOB 5: Final Report Aggregation
  # ================================================================================
  generate-final-report:
    name: ðŸ§¾ Generate Final DevSecOps Report
    runs-on: ubuntu-latest
    needs: [continuous-integration, sast-codeql, sca-dependencies, dast-zap-scan]
    if: always()
    
    steps:
      - name: ðŸ“¥ Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-reports
      
      - name: ðŸ“Š Generate consolidated report
        run: |
          echo "==========================================================" > final-devsecops-report.txt
          echo "         DevSecOps Pipeline - Final Report" >> final-devsecops-report.txt
          echo "         OWASP NodeGoat Security Assessment" >> final-devsecops-report.txt
          echo "==========================================================" >> final-devsecops-report.txt
          echo "" >> final-devsecops-report.txt
          echo "Pipeline Run: ${{ github.run_number }}" >> final-devsecops-report.txt
          echo "Timestamp: $(date)" >> final-devsecops-report.txt
          echo "Branch: ${{ github.ref_name }}" >> final-devsecops-report.txt
          echo "Commit: ${{ github.sha }}" >> final-devsecops-report.txt
          echo "Triggered by: ${{ github.actor }}" >> final-devsecops-report.txt
          echo "" >> final-devsecops-report.txt
          echo "==========================================================" >> final-devsecops-report.txt
          echo "Pipeline Stages Summary" >> final-devsecops-report.txt
          echo "==========================================================" >> final-devsecops-report.txt
          echo "" >> final-devsecops-report.txt
          
          # Check job statuses
          echo "âœ… Stage 1: Continuous Integration (CI)" >> final-devsecops-report.txt
          echo "   Status: ${{ needs.continuous-integration.result }}" >> final-devsecops-report.txt
          echo "" >> final-devsecops-report.txt
          
          echo "âœ… Stage 2: SAST - CodeQL Analysis" >> final-devsecops-report.txt
          echo "   Status: ${{ needs.sast-codeql.result }}" >> final-devsecops-report.txt
          echo "" >> final-devsecops-report.txt
          
          echo "âœ… Stage 3: SCA - Dependency Scanning" >> final-devsecops-report.txt
          echo "   Status: ${{ needs.sca-dependencies.result }}" >> final-devsecops-report.txt
          echo "" >> final-devsecops-report.txt
          
          echo "âœ… Stage 4: DAST - OWASP ZAP Scan" >> final-devsecops-report.txt
          echo "   Status: ${{ needs.dast-zap-scan.result }}" >> final-devsecops-report.txt
          echo "" >> final-devsecops-report.txt
          
          echo "==========================================================" >> final-devsecops-report.txt
          echo "Available Reports" >> final-devsecops-report.txt
          echo "==========================================================" >> final-devsecops-report.txt
          echo "" >> final-devsecops-report.txt
          
          find all-reports -type f | while read file; do
            echo "ðŸ“„ $file" >> final-devsecops-report.txt
          done
          
          echo "" >> final-devsecops-report.txt
          echo "==========================================================" >> final-devsecops-report.txt
          echo "Next Steps" >> final-devsecops-report.txt
          echo "==========================================================" >> final-devsecops-report.txt
          echo "" >> final-devsecops-report.txt
          echo "1. Review all security findings in the artifacts" >> final-devsecops-report.txt
          echo "2. Check the Security tab for CodeQL alerts" >> final-devsecops-report.txt
          echo "3. Prioritize and remediate high/critical vulnerabilities" >> final-devsecops-report.txt
          echo "4. Update dependencies with security patches" >> final-devsecops-report.txt
          echo "5. Re-run the pipeline after fixes" >> final-devsecops-report.txt
          echo "" >> final-devsecops-report.txt
          echo "==========================================================" >> final-devsecops-report.txt
          
          cat final-devsecops-report.txt
      
      - name: ðŸ“¤ Upload final consolidated report
        uses: actions/upload-artifact@v4
        with:
          name: final-devsecops-report
          path: |
            final-devsecops-report.txt
            all-reports/
          retention-days: 90
